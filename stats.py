#!/usr/bin/python

import config
import datetime
import json


class SerializableBase:
    attr_names = []
    def __init__(self, **kwargs):
        for attr_name in self.attr_names:
            setattr(self, attr_name, kwargs.get(attr_name))

    def serialize_to_json(self):
        return {name: getattr(self, name) for name in self.attr_names}

class FuncLaunch(SerializableBase):
    attr_names = [
        "date_of_launch", # as string, not as datetime.datetime!
        "elapsed_time", # as string, not as datetime.timedelta!
        "new_unique_cves",
        "new_url_matches",
        "func_name",
    ]

class Stats(SerializableBase):
    attr_names = [
        "funcs",
        "comment",
        "total_unique_cves",
        "total_url_matches",
        "id",
    ]

    def add_func_launch(self, func):
        if not self.funcs:
            self.funcs = []
            self.total_unique_cves = 0
            self.total_url_matches = 0
        self.funcs.append(func)
        self.total_unique_cves += func.new_unique_cves
        self.total_url_matches += func.new_url_matches


def record_stats_decorator(func):
    def wrapper(*args, **kwargs):
        # Measure the execution stats.
        start = datetime.datetime.now()
        counter = func(*args, **kwargs)
        delta = datetime.datetime.now() - start

        # Read previous data.
        try:
            with open(config.STATS_FILE, "r") as f:
                prev_stats = json.load(f)
        except:
            # If the file does not exists or is empty.
            prev_stats = []

        # Marshal the data.
        first_func_launch = not hasattr(config, config.STATS_DECORATOR_KEY)
        if first_func_launch:
            current_stats = Stats()
            setattr(config, config.STATS_DECORATOR_KEY, current_stats)
            current_id = reduce(max, [x["id"] for x in prev_stats], -1) + 1
            current_stats.id = current_id
        else:
            current_stats = getattr(config, config.STATS_DECORATOR_KEY)
        current_func_launch = FuncLaunch(
                date_of_launch=start.strftime(config.DATE_TIME_FORMAT),
                elapsed_time=str(delta),
                new_unique_cves=counter.unique_cves_count,
                new_url_matches=counter.working_urls_count,
                func_name=func.func_name
            )
        current_stats.add_func_launch(current_func_launch)

        # Combine current and previous data.
        if first_func_launch:
            prev_stats.append(current_stats)
        else:
            # Fields are sorted by id.
            prev_stats[current_stats.id] = current_stats

        # Write combined data.
        with open(config.STATS_FILE, "w") as f:
            json.dump(prev_stats, f, indent=4,
                    default=SerializableBase.serialize_to_json)

    return wrapper
