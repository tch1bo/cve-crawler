import db
import flask
import stats

from models import CVE, NonCVE, CommitHash, URL

app = flask.Flask(__name__)

def count(table):
    return db.global_session.query(table).count()

def get_all_func(table):
    return db.global_session.query(table).order_by(table.id).all

def get_non_empty_func(table, collection_key):
    attr = getattr(table, collection_key)
    return db.global_session.query(table).filter(attr.any()).order_by(table.id).all

def get_by_id(table, obj_id):
    return db.global_session.query(table).get(obj_id)

@app.route("/")
def index():
    cve_count = stats.measure_stats().cves_count
    kwargs = {
            "cve_count": cve_count,
            "total_cve_count": count(CVE),
            "total_non_cve_count": count(NonCVE),
            "url_count": count(URL),
            "hash_count": count(CommitHash),
    }
    return flask.render_template("index.html", **kwargs)

def collection_endpoint_factory(endpoint_name, **kwargs):
    def inner():
        new_kwargs = {key: func() for key, func in kwargs.iteritems()}
        return flask.render_template(endpoint_name + ".html", **new_kwargs)
    app.add_url_rule("/" + endpoint_name, endpoint_name, inner)
    return inner

cves_endpoint = collection_endpoint_factory("cves",
        cves=get_non_empty_func(CVE, "urls"),
        non_cves=get_non_empty_func(NonCVE, "urls"),
)

urls_endpoint = collection_endpoint_factory("urls",
        urls=get_all_func(URL),
)

hashes_endpoint = collection_endpoint_factory("hashes",
        hashes=get_all_func(CommitHash),
)

def item_endpoint_factory(table):
    name = table.__tablename__
    def inner(obj_id):
        kwargs = {name: get_by_id(table, obj_id)}
        print kwargs
        return flask.render_template(name + ".html", **kwargs)
    app.add_url_rule("/{0}/<int:obj_id>".format(name), name, inner)
    return inner

item_endpoints = map(item_endpoint_factory, [CVE, NonCVE, CommitHash, URL])

if __name__ == "__main__":
    app.run(port=10000, debug=True)
