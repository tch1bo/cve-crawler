#!/usr/bin/python

import config
import db
import json
import models
import requests

github_auth = None

CODE_OK = 200
""" # 403 - Number of attempts exceeded. """
CODE_TIMEOUT = 403
""" 422 - Validation problems. """
CODE_VALIDATION = 422

def set_github_auth():
    global github_auth
    github_auth = \
            requests.auth.HTTPBasicAuth(config.gusername, config.gpassword)

def get_api_url(user, repo):
    t = "https://api.github.com/repos/{0}/{1}/contents"
    return t.format(user, repo)

def get_raw_resource(url, **kwargs):
    req = requests.get(url, **kwargs)
    if req.status_code != 200:
        raise Exception("server replied with {0}. Text: {1}".format(
            req.status_code, req.text))
    return req.text

def get_json_resource(url, **kwargs):
    return json.loads(get_raw_resource(url, **kwargs))

def github_search(query):
    query_url = "https://api.github.com/search/commits"
    # Github search api returns 100 results per page. Do we need to scan
    # all the pages?
    req = requests.get(query_url, auth=github_auth,
            headers={"Accept": "application/vnd.github.cloak-preview"},
            params={"q": query},
    )
    text = json.loads(req.text) if req.status_code == CODE_OK else req.text
    return req.status_code, text

def download_file(url, local_path):
    r = requests.get(url, stream=False)
    with open(local_path, "wb") as f:
        for chunk in r.iter_content(chunk_size=1024):
            if chunk:
                f.write(chunk)
